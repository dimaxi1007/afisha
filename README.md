Анализ лояльности пользователей Яндекс Афиши с помощью Python
Итак, вы познакомились с данными и подготовили SQL-запрос, который поможет выгрузить выборку данных для анализа. Пора приступать к нему!
Напомним ключевую цель и промежуточные итоги проекта:
Команда маркетинга хочет лучше понимать поведение пользователей. Для этого они просят вас провести исследовательский анализ данных, чтобы понять, какие пользователи с большей вероятностью возвращаются на платформу и делают заказы повторно. Это позволит:
Быстро выявлять перспективных клиентов и предлагать им персонализированные условия.
Точно настраивать рекламу на аудитории с высокой вероятностью возврата.
Оптимизировать маркетинговые бюджеты.
Повысить общий уровень удержания клиентов.
Выгрузка из базы данных SQL позволила собрать следующие данные:
user_id — уникальный идентификатор пользователя, совершившего заказ;
device_type_canonical — тип устройства, с которого был оформлен заказ ( mobile — мобильные устройства, desktop — стационарные);
order_id — уникальный идентификатор заказа;
order_dt — дата создания заказа (используйте данные created_dt_msk );
order_ts — дата и время создания заказа (используйте данные created_ts_msk );
currency_code — валюта оплаты;
revenue — выручка от заказа;
tickets_count — количество купленных билетов;
days_since_prev — количество дней от предыдущей покупки пользователя, для пользователей с одной покупкой — значение пропущено;
event_id — уникальный идентификатор мероприятия;
service_name — название билетного оператора;
event_type_main — основной тип мероприятия (театральная постановка, концерт и так далее);
region_name — название региона, в котором прошло мероприятие;
city_name — название города, в котором прошло мероприятие.
Далее в этом уроке вы увидите руководство по выполнению проекта. Чтобы ваше исследование шло оптимальным путём, чётко следуйте изложенным дальше шагам. Углублённая предобработка и исследование неприоритетных для проекта вопросов может потребовать много дополнительного времени.
Проводя исследование, оставляйте в тетрадке Jupyter комментарии с пояснениями о том, что вы делаете и зачем — это полезная привычка во время обучения. Пользуйтесь общими правилами:
Начните записи в тетрадке с введения, в котором опишите контекст и цели проекта. Это хорошая практика, которая помогает понять исследование тем, кто впервые его увидит.
Записывайте в комментариях к коду всё, что относится к нему.
Записывайте в ячейках типа Markdown, как именно ваши дальнейшие действия приближают вас к выполнению цели проекта.
Пройдя каждый шаг проекта, обязательно формулируйте промежуточные выводы.
Не забывайте периодически сохранять проект, иначе ваш код может пропасть из-за непредвиденной технической ошибки.
Инструкция по выполнению проекта
Шаг 1. Загрузка данных и их предобработка
Задача 1.1: Напишите SQL-запрос, выгружающий в датафрейм pandas необходимые данные. Используйте следующие параметры для подключения к базе данных data-analyst-afisha:
Хост — rc1b-wcoijxj3yxfsf3fs.mdb.yandexcloud.net
База данных — data-analyst-afisha
Порт — 6432
Аутентификация — Database Native
Пользователь — praktikum_student
Пароль — Sdf4$2;d-d30pp
Для выгрузки используйте запрос, который вы писали в третьем уроке проекта, «Выгрузка данных с помощью SQL». Инструкция по тому, как это сделать, дана в четвёртом уроке, «Подключение к базе данных с помощью Python».
Не забудьте снять ограничение на вывод 10 строк!
Задача 1.2: Изучите общую информацию о выгруженных данных. Оцените корректность выгрузки и объём полученных данных.
Предположите, какие шаги необходимо сделать на стадии предобработки данных — например, скорректировать типы данных.
Зафиксируйте основную информацию о данных в кратком промежуточном выводе.
Шаг 2. Предобработка данных
Выполните все стандартные действия по предобработке данных:
Задача 2.1. Данные о выручке сервиса представлены в российских рублях и казахстанских тенге. Приведите выручку к единой валюте — российскому рублю.
Для этого используйте датасет с информацией о курсе казахстанского тенге по отношению к российскому рублю за 2024 год — final_tickets_tenge_df.csv. Его можно скачать по ссылке. Значения в рублях представлено для 100 тенге.
Результаты преобразования сохраните в новый столбец revenue_rub.
Задача 2.2.
Проверьте данные на пропущенные значения. Если выгрузка из SQL была успешной, то пропуски должны быть только в столбце days_since_prev.
Преобразуйте типы данных в некоторых столбцах, если это необходимо. Обратите внимание на данные с датой и временем, а также на числовые данные, размерность которых можно сократить.
Изучите значения в ключевых столбцах. Обработайте ошибки, если обнаружите их.
Проверьте, какие категории указаны в столбцах с номинальными данными. Есть ли среди категорий такие, что обозначают пропуски в данных или отсутствие информации? Проведите нормализацию данных, если это необходимо.
Проверьте распределение численных данных и наличие в них выбросов. Для этого используйте статистические показатели, гистограммы распределения значений или диаграммы размаха. Важные показатели в рамках поставленной задачи — это выручка с заказа ( revenue_rub ) и количество билетов в заказе ( tickets_count ), поэтому в первую очередь проверьте данные в этих столбцах. Если обнаружите выбросы в поле revenue_rub, то отфильтруйте значения по 99 перцентилю.
После предобработки проверьте, были ли отфильтрованы данные. Если были, то оцените, в каком объёме. Сформулируйте промежуточный вывод, зафиксировав основные действия и описания новых столбцов.
Шаг 3. Создание профиля пользователя
В будущем отдел маркетинга планирует создать модель для прогнозирования возврата пользователей. Поэтому сейчас они просят вас построить агрегированные признаки, описывающие поведение и профиль каждого пользователя.
Задача 3.1. Постройте профиль пользователя — для каждого пользователя найдите:
дату первого и последнего заказа;
устройство, с которого был сделан первый заказ;
регион, в котором был сделан первый заказ;
билетного партнёра, к которому обращались при первом заказе;
жанр первого посещённого мероприятия (используйте поле event_type_main );
общее количество заказов;
средняя выручка с одного заказа в рублях;
среднее количество билетов в заказе;
среднее время между заказами.
После этого добавьте два бинарных признака:
is_two — совершил ли пользователь 2 и более заказа;
is_five — совершил ли пользователь 5 и более заказов.
Рекомендация: перед тем как строить профиль, отсортируйте данные по времени совершения заказа.
Задача 3.2. Прежде чем проводить исследовательский анализ данных и делать выводы, важно понять, с какими данными вы работаете: насколько они репрезентативны и нет ли в них аномалий.
Используя данные о профилях пользователей, рассчитайте:
общее число пользователей в выборке;
среднюю выручку с одного заказа;
долю пользователей, совершивших 2 и более заказа;
долю пользователей, совершивших 5 и более заказов.
Также изучите статистические показатели:
по общему числу заказов;
по среднему числу билетов в заказе;
по среднему количеству дней между покупками.
По результатам оцените данные: достаточно ли их по объёму, есть ли аномальные значения в данных о количестве заказов и среднем количестве билетов?
Если вы найдёте аномальные значения, опишите их и примите обоснованное решение о том, как с ними поступить:
Оставить и учитывать их при анализе?
Отфильтровать данные по какому-то значению, например, по 95-му или 99-му перцентилю?
Если вы проведёте фильтрацию, то вычислите объём отфильтрованных данных и выведите статистические показатели по обновлённому датасету.
Шаг 4. Исследовательский анализ данных
Следующий этап — исследование признаков, влияющих на возврат пользователей, то есть на совершение повторного заказа. Для этого используйте профили пользователей.
4.1. Исследование признаков первого заказа и их связи с возвращением на платформу
Исследуйте признаки, описывающие первый заказ пользователя, и выясните, влияют ли они на вероятность возвращения пользователя.
Задача 4.1.1. Изучите распределение пользователей по признакам.
Сгруппируйте пользователей:
по типу их первого мероприятия;
по типу устройства, с которого совершена первая покупка;
по региону проведения мероприятия из первого заказа;
по билетному оператору, продавшему билеты на первый заказ.
Подсчитайте общее количество пользователей в каждом сегменте и их долю в разрезе каждого признака. Сегмент — это группа пользователей, объединённых определённым признаком, то есть объединённые принадлежностью к категории. Например, все клиенты, сделавшие первый заказ с мобильного телефона, — это сегмент.
Ответьте на вопрос: равномерно ли распределены пользователи по сегментам или есть выраженные «точки входа» — сегменты с наибольшим числом пользователей?
Задача 4.1.2. Проанализируйте возвраты пользователей:
Для каждого сегмента вычислите долю пользователей, совершивших два и более заказа.
Визуализируйте результат подходящим графиком. Если сегментов слишком много, то поместите на график только 10 сегментов с наибольшим количеством пользователей. Такое возможно с сегментами по региону и по билетному оператору.
Ответьте на вопросы:
Какие сегменты пользователей чаще возвращаются на Яндекс Афишу?
Наблюдаются ли успешные «точки входа» — такие сегменты, в которых пользователи чаще совершают повторный заказ, чем в среднем по выборке?
При интерпретации результатов учитывайте размер сегментов: если в сегменте мало пользователей (например, десятки), то доли могут быть нестабильными и недостоверными, то есть показывать широкую вариацию значений.
Задача 4.1.3. Опираясь на выводы из задач выше, проверьте продуктовые гипотезы:
Гипотеза 1. Тип мероприятия влияет на вероятность возврата на Яндекс Афишу: пользователи, которые совершили первый заказ на спортивные мероприятия, совершают повторный заказ чаще, чем пользователи, оформившие свой первый заказ на концерты.
Гипотеза 2. В регионах, где больше всего пользователей посещают мероприятия, выше доля повторных заказов, чем в менее активных регионах.
4.2. Исследование поведения пользователей через показатели выручки и состава заказа
Изучите количественные характеристики заказов пользователей, чтобы узнать среднюю выручку сервиса с заказа и количество билетов, которое пользователи обычно покупают.
Эти метрики важны не только для оценки выручки, но и для оценки вовлечённости пользователей. Возможно, пользователи с более крупными и дорогими заказами более заинтересованы в сервисе и поэтому чаще возвращаются.
Задача 4.2.1. Проследите связь между средней выручкой сервиса с заказа и повторными заказами.
Постройте сравнительные гистограммы распределения средней выручки с билета ( avg_revenue_rub ):
для пользователей, совершивших один заказ;
для вернувшихся пользователей, совершивших 2 и более заказа.
Ответьте на вопросы: 
В каких диапазонах средней выручки концентрируются пользователи из каждой группы?
Есть ли различия между группами?
Рекомендации:
Используйте одинаковые интервалы ( bins ) и прозрачность ( alpha ), чтобы визуально сопоставить распределения.
Задайте параметру density значение True, чтобы сравнивать форму распределений, даже если число пользователей в группах отличается.
Задача 4.2.2. Сравните распределение по средней выручке с заказа в двух группах пользователей:
совершившие 2–4 заказа;
совершившие 5 и более заказов.
Ответьте на вопрос: есть ли различия по значению средней выручки с заказа между пользователями этих двух групп?
Задача 4.2.3. Проанализируйте влияние среднего количества билетов в заказе на вероятность повторной покупки.
Изучите распределение пользователей по среднему количеству билетов в заказе ( avg_tickets_count ) и опишите основные наблюдения.
Разделите пользователей на несколько сегментов по среднему количеству билетов в заказе:
от 1 до 2 билетов;
от 2 до 3 билетов;
от 3 до 5 билетов;
от 5 и более билетов.
Для каждого сегмента подсчитайте общее число пользователей и долю пользователей, совершивших повторные заказы.
Ответьте на вопросы:
Как распределены пользователи по сегментам — равномерно или сконцентрировано?
Есть ли сегменты с аномально высокой или низкой долей повторных покупок?
4.3. Исследование временных характеристик первого заказа и их влияния на повторные покупки
Изучите временные параметры, связанные с первым заказом пользователей:
день недели первой покупки;
время с момента первой покупки — лайфтайм;
средний интервал между покупками пользователей с повторными заказами.
Задача 4.3.1. Проанализируйте, как день недели, в которой была совершена первая покупка, влияет на поведение пользователей.
По данным даты первого заказа выделите день недели.
Для каждого дня недели подсчитайте общее число пользователей и долю пользователей, совершивших повторные заказы. Результаты визуализируйте.
Ответьте на вопрос: влияет ли день недели, в которую совершена первая покупка, на вероятность возврата клиента?
Задача 4.3.2. Изучите, как средний интервал между заказами влияет на удержание клиентов.
Рассчитайте среднее время между заказами для двух групп пользователей:
совершившие 2–4 заказа;
совершившие 5 и более заказов.
Исследуйте, как средний интервал между заказами влияет на вероятность повторного заказа, и сделайте выводы.
4.4. Корреляционный анализ количества покупок и признаков пользователя
Изучите, какие характеристики первого заказа и профиля пользователя могут быть связаны с числом покупок. Для этого используйте универсальный коэффициент корреляции phi_k, который позволяет анализировать как числовые, так и категориальные признаки.
Задача 4.4.1: Проведите корреляционный анализ:
Рассчитайте коэффициент корреляции phi_k между признаками профиля пользователя и числом заказов ( total_orders ). При необходимости используйте параметр interval_cols для определения интервальных данных.
Проанализируйте полученные результаты. Если полученные значения будут близки к нулю, проверьте разброс данных в total_orders. Такое возможно, когда в данных преобладает одно значение: в таком случае корреляционный анализ может показать отсутствие связей. Чтобы этого избежать, выделите сегменты пользователей по полю total_orders, а затем повторите корреляционный анализ. Выделите такие сегменты:
1 заказ;
от 2 до 4 заказов;
от 5 и выше.
Визуализируйте результат корреляции с помощью тепловой карты.
Ответьте на вопрос: какие признаки наиболее связаны с количеством заказов?
5. Общие выводы и рекомендации
В конце проекта напишите общий вывод и рекомендации: расскажите заказчику, на что нужно обратить внимание. В выводах кратко укажите:
Информацию о данных, с которыми вы работали, и то, как они были подготовлены: например, расскажите о фильтрации данных, переводе тенге в рубли, фильтрации выбросов.
Основные результаты анализа. Например, укажите:
Сколько пользователей в выборке? Как распределены пользователи по числу заказов? Какие ещё статистические показатели вы подсчитали важным во время изучения данных?
Какие признаки первого заказа связаны с возвратом пользователей?
Как связаны средняя выручка и количество билетов в заказе с вероятностью повторных покупок?
Какие временные характеристики влияют на удержание (день недели, интервалы между покупками)?
Какие характеристики первого заказа и профиля пользователя могут быть связаны с числом покупок согласно результатам корреляционного анализа?
Дополните выводы информацией, которая покажется вам важной и интересной. Следите за общим объёмом выводов — они должны быть компактными и ёмкими.
В конце предложите заказчику рекомендации о том, как именно действовать в его ситуации. Например, укажите, на какие сегменты пользователей стоит обратить внимание в первую очередь, а какие нуждаются в дополнительных маркетинговых усилиях.
6. Финализация проекта и публикация в Git
Когда вы закончите анализировать данные, оформите проект, а затем опубликуйте его.
Выполните следующие действия:
Создайте файл .gitignore. Добавьте в него все временные и чувствительные файлы, которые не должны попасть в репозиторий.
Сформируйте файл requirements.txt. Зафиксируйте все библиотеки, которые вы использовали в проекте.
Вынести все чувствительные данные (параметры подключения к базе) в .env -файл.
Проверьте, что проект запускается и воспроизводим.
Загрузите проект в публичный репозиторий — например, на GitHub. Убедитесь, что все нужные файлы находятся в репозитории, исключая те, что в .gitignore. Ссылка на репозиторий понадобится для отправки проекта на проверку. Вставьте её в шаблон проекта в тетрадке Jupyter Notebook перед отправкой проекта на ревью.
Проверка проекта ревьюером
Не забывайте периодически сохранять проект, иначе ваш код может пропасть из-за случайных ошибок.
Перед отправкой проверьте, работает ли весь код проекта. Для этого перезапустите ядро и выполните все ячейки кода с помощью команд Kernel → Restart & Run All. Убедитесь, что все ячейки корректно отработали. Затем, если работает, нажмите кнопку «Отправить на проверку».
Если вы работаете локально, загрузите тетрадь в расширении .ipynb и нажмите кнопку «Отправить на проверку».
Важное про доработку проекта
Если ваш проект отправили на доработку, вносите исправления в тот же самый проект. Не создавайте новый файл и не удаляйте комментарии ревьюера — так будет проще проверить изменения.
Отвечайте на комментарии ревьюера в ячейках Markdown. Вы можете создавать их в месте, следующем за комментарием.
Если после доработки вы сдадите новый проект без комментариев, то ревьюер не сможет его проверить. Вам отправят последнюю версию вашего проекта, которую понадобится доработать по комментариям.
Умение работать в таком формате — важный навык в профессиональной среде. Правки часто вносят в существующий код по замечаниям руководителей и других коллег, которые хотят сразу видеть изменения. Поэтому важно учиться исправлять проект, опираясь на комментарии.
